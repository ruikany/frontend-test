<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Realtime STT Client</title>
    </head>
    <body>
        <div id="controls">
            <h3>Live Transcribe</h3>
            <div class="button-group">
                <button id="startBtn">Start</button>
                <button id="stopBtn">Stop</button>
            </div>
            <div id="status">Ready to connect</div>
        </div>

        <div id="textDisplay"></div>

        <script type="module">
            import { TranscriptionClient } from './transcription-client.js';

            const WS_URL = "wss://going-considering-const-eve.trycloudflare.com/ws/transcribe";
            const statusDiv = document.getElementById("status");
            const displayDiv = document.getElementById("textDisplay");
            const startBtn = document.getElementById("startBtn");
            const stopBtn = document.getElementById("stopBtn");
            let fullSentences = [];

            function setRecordingState(isRecording) {
                startBtn.disabled = isRecording;
                stopBtn.disabled = !isRecording;
            }

            function updateDisplay(realtimeText) {
                let html = fullSentences.map((s) => `<span>${s}</span> `).join("");
                if (realtimeText) {
                    html += `<span class="realtime">${realtimeText}</span>`;
                }
                displayDiv.innerHTML = html;
                displayDiv.scrollTop = displayDiv.scrollHeight;
            }

            const client = new TranscriptionClient(WS_URL, {
                onRealtime: (text) => {
                    updateDisplay(text);
                },
                onSentence: (text) => {
                    fullSentences.push(text);
                    updateDisplay("");
                },
                onStatus: (status) => {
                    statusDiv.textContent = status;
                    if (status === 'Ready' || status === 'Disconnected') {
                        setRecordingState(false);
                    }
                    if (status === 'Live') {
                        setRecordingState(true);
                    }
                },
                onError: (err) => {
                    console.error("Client Error:", err);
                    setRecordingState(false);
                }
            });

            startBtn.onclick = async () => {
                startBtn.disabled = true;
                try {
                    await client.start();
                } catch (e) {
                    startBtn.disabled = false;
                }
            }

            stopBtn.onclick = () => {
                client.stop();
            }
        </script>
    </body>
</html>
