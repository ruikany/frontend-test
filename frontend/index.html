<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime STT Client</title>
    <style>
      body {
        background-color: #1a1a1a;
        color: #e0e0e0;
        font-family: "Courier New", Courier, monospace;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #2d2d2d;
        border-radius: 8px;
        text-align: center;
      }
      input {
        padding: 8px;
        background: #333;
        border: 1px solid #555;
        color: white;
        width: 300px;
      }
      button {
        padding: 8px 16px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
      }
      button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }
      #status {
        margin-top: 10px;
        font-size: 0.9em;
        color: #888;
      }
      #textDisplay {
        width: 90%;
        max-width: 800px;
        min-height: 300px;
        border: 1px solid #444;
        padding: 20px;
        border-radius: 8px;
        background-color: #000;
        line-height: 1.6;
        white-space: pre-wrap;
      }
      .yellow {
        color: #f1c40f;
      }
      .cyan {
        color: #00e5ff;
      }
      .realtime {
        color: #888;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <h3>STT Config</h3>
      <input
        type="text"
        id="wsUrl"
        value="ws://localhost:8000/ws/transcribe"
        placeholder="WebSocket URL"
      />
      <button id="connectBtn" onclick="startApp()">Start Recording</button>
      <div id="status">Ready to connect...</div>
    </div>

    <div id="textDisplay"></div>

    <script>
      let socket;
      let audioContext;
      let processor;
      let inputSource;
      let isConnected = false;
      let fullSentences = [];

      const statusDiv = document.getElementById("status");
      const displayDiv = document.getElementById("textDisplay");
      const connectBtn = document.getElementById("connectBtn");

      function updateDisplay(realtimeText) {
        let html = fullSentences
          .map(
            (s, i) =>
              `<span class="${i % 2 === 0 ? "yellow" : "cyan"}">${s}</span> `,
          )
          .join("");

        if (realtimeText) {
          html += `<span class="realtime">${realtimeText}</span>`;
        }
        displayDiv.innerHTML = html;
        // Auto scroll to bottom
        displayDiv.scrollTop = displayDiv.scrollHeight;
      }

      async function startApp() {
        const wsUrl = document.getElementById("wsUrl").value;
        connectBtn.disabled = true;
        statusDiv.textContent = "Connecting to Server...";

        try {
          // 1. Initialize Microphone
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
            },
          });

          // 2. Connect WebSocket
          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            statusDiv.textContent = "Server Connected. Initializing Audio...";
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "status" && data.text === "ready") {
              statusDiv.textContent = "ðŸ”´ Recording & Transcribing...";
              startAudioProcessing(stream);
              isConnected = true;
            } else if (data.type === "realtime") {
              updateDisplay(data.text);
            } else if (data.type === "fullSentence") {
              fullSentences.push(data.text);
              updateDisplay("");
            }
          };

          socket.onclose = () => {
            statusDiv.textContent = "Disconnected.";
            connectBtn.disabled = false;
            stopAudioProcessing();
          };

          socket.onerror = (err) => {
            console.error(err);
            statusDiv.textContent = "Error connecting to server.";
            connectBtn.disabled = false;
          };
        } catch (err) {
          console.error(err);
          statusDiv.textContent = "Microphone Error: " + err.message;
          connectBtn.disabled = false;
        }
      }

      function startAudioProcessing(stream) {
        audioContext = new AudioContext();
        inputSource = audioContext.createMediaStreamSource(stream);

        // Using 1024 to balance network efficiency with low latency
        processor = audioContext.createScriptProcessor(1024, 1, 1);

        inputSource.connect(processor);
        processor.connect(audioContext.destination);

        processor.onaudioprocess = (e) => {
          if (!isConnected || socket.readyState !== WebSocket.OPEN) return;

          const inputData = e.inputBuffer.getChannelData(0);
          const outputData = new Int16Array(inputData.length);

          // Convert to 16-bit PCM (Exact logic from your working client.js)
          for (let i = 0; i < inputData.length; i++) {
            outputData[i] = Math.max(
              -32768,
              Math.min(32767, inputData[i] * 32768),
            );
          }

          // Prepare Message: [Len (4 bytes)] + [JSON Metadata] + [Audio Bytes]
          const metadata = JSON.stringify({
            sampleRate: audioContext.sampleRate,
          });
          const metadataBytes = new TextEncoder().encode(metadata);

          const lenBuffer = new ArrayBuffer(4);
          new DataView(lenBuffer).setInt32(0, metadataBytes.byteLength, true);

          const blob = new Blob([lenBuffer, metadataBytes, outputData.buffer]);
          socket.send(blob);
        };
      }

      function stopAudioProcessing() {
        if (processor) {
          processor.disconnect();
          processor = null;
        }
        if (inputSource) {
          inputSource.disconnect();
          inputSource = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        isConnected = false;
      }
    </script>
  </body>
</html>
